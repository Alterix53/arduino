#include <WiFi.h>
#include <PubSubClient.h>
#include <ESP32Servo.h>
#include "DHT.h"

// --- WIFI & MQTT ---
const char* ssid = "Wokwi-GUEST";
const char* password = "";
const char* mqtt_server = "broker.hivemq.com";

// --- TOPIC ---
const char* topic_temp = "smartdoor/nhom10/temperature";
const char* topic_hum  = "smartdoor/nhom10/humidity";
const char* topic_st_door   = "smartdoor/nhom10/status/door";
const char* topic_st_buzzer = "smartdoor/nhom10/status/buzzer";
const char* topic_st_sensor = "smartdoor/nhom10/status/sensor";
const char* topic_cmd = "smartdoor/nhom10/cmd";

WiFiClient espClient;
PubSubClient client(espClient);

// --- PHẦN CỨNG ---
#define SERVO_PIN 13
#define TRIG_PIN  5 
#define ECHO_PIN  18 
#define DHT_PIN   27
#define BUZZER_PIN 4
#define LED_PIN    2    // <--- Chân đèn cảnh báo mới
#define DHT_TYPE DHT22

Servo doorLock;
DHT dht(DHT_PIN, DHT_TYPE);

// --- BIẾN TOÀN CỤC ---
unsigned long lastMsg = 0;
unsigned long doorOpenTime = 0; 
unsigned long previousBlink = 0; // Biến để đếm giờ chớp đèn
bool isDoorOpen = false;
bool ledState = LOW; // Trạng thái hiện tại của đèn (Tắt/Bật)

// Cấu hình (Mặc định)
bool isSensorActive = true;     
int tempThreshold = 40;
int distThreshold = 50; // <--- Ngưỡng khoảng cách mặc định (cm)
bool isBuzzerManual = false; 

void setup() {
  Serial.begin(115200);
  doorLock.attach(SERVO_PIN);
  doorLock.write(0);
  
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  dht.begin();
  pinMode(BUZZER_PIN, OUTPUT);

  digitalWrite(BUZZER_PIN, LOW); // <--- THÊM DÒNG NÀY (Đảm bảo điện áp thấp)
  noTone(BUZZER_PIN);            // <--- THÊM DÒNG NÀY (Đảm bảo tắt xung PWM)

  pinMode(LED_PIN, OUTPUT); // <--- Khởi tạo đèn

  setup_wifi();
  client.setServer(mqtt_server, 1883);
  client.setCallback(callback);
}

void setup_wifi() {
  delay(10);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }
}

void callback(char* topic, byte* message, unsigned int length) {
  String msg;
  for (int i = 0; i < length; i++) msg += (char)message[i];
  Serial.print("Lenh: "); Serial.println(msg);

  if (msg == "OPEN") { 
    doorLock.write(90); isDoorOpen = true; doorOpenTime = millis();
    client.publish(topic_st_door, "Đang Mở");
  } 
  else if (msg == "CLOSE") {
    doorLock.write(0); isDoorOpen = false;
    client.publish(topic_st_door, "Đang Khóa");
  }
  else if (msg == "BUZZER_ON") {
    isBuzzerManual = true; tone(BUZZER_PIN, 1000);
    client.publish(topic_st_buzzer, "Đang Kêu");
  }
  else if (msg == "BUZZER_OFF") {
    isBuzzerManual = false; noTone(BUZZER_PIN);
    client.publish(topic_st_buzzer, "Yên Lặng");
  }
  else if (msg == "SENSOR_ON") {
    isSensorActive = true; client.publish(topic_st_sensor, "Đang Bật");
  }
  else if (msg == "SENSOR_OFF") {
    isSensorActive = false; client.publish(topic_st_sensor, "Đã Tắt");
  }
  else if (msg.startsWith("SET_TEMP:")) {
    tempThreshold = msg.substring(9).toInt();
  }
  // --- NHẬN LỆNH CÀI ĐẶT KHOẢNG CÁCH ---
  else if (msg.startsWith("SET_DIST:")) {
    distThreshold = msg.substring(9).toInt();
    Serial.println("New Dist Limit: " + String(distThreshold));
  }
}

void reconnect() {
  while (!client.connected()) {
    if (client.connect("ESP32_Nhom10_Main")) {
      client.subscribe(topic_cmd);
      client.publish(topic_st_door, "Đang Khóa");
    } else delay(5000);
  }
}

void loop() {
  // 1. Giữ kết nối MQTT
  if (!client.connected()) reconnect();
  client.loop();

  // 2. AUTO-LOCK (Tự động khóa cửa sau 5s mở)
  if (isDoorOpen && (millis() - doorOpenTime > 5000)) {
    doorLock.write(0); 
    isDoorOpen = false;
    client.publish(topic_st_door, "Đang Khóa (Auto)");
  }

  // 3. ĐỌC CẢM BIẾN SIÊU ÂM (HC-SR04)
  digitalWrite(TRIG_PIN, LOW); delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH); delayMicroseconds(10); digitalWrite(TRIG_PIN, LOW);
  long duration = pulseIn(ECHO_PIN, HIGH);
  int distance = duration * 0.034 / 2;

  // Logic Đèn LED chớp tắt (Blink không dùng delay)
  if (distance > 0 && distance < distThreshold) {
      if (millis() - previousBlink >= 200) { // Chớp mỗi 200ms
        previousBlink = millis();
        ledState = !ledState;
        digitalWrite(LED_PIN, ledState);
      }
  } else {
      digitalWrite(LED_PIN, LOW); // Tắt hẳn đèn khi không có người
  }

  // 4. ĐỌC DHT22 & XỬ LÝ CÒI (Chu kỳ 2 giây/lần)
  long now = millis();
  if (now - lastMsg > 2000) { 
    lastMsg = now;
    
    if (isSensorActive) {
      float h = dht.readHumidity();
      float t = dht.readTemperature();

      // Kiểm tra xem cảm biến có đọc được số không (tránh lỗi NaN)
      if (!isnan(t) && !isnan(h)) {
        // A. Gửi dữ liệu lên Server
        client.publish(topic_temp, String(t, 1).c_str());
        client.publish(topic_hum, String(h, 1).c_str());
        
        // B. Logic Còi Báo Động (Ưu tiên: Thủ công -> Nhiệt độ -> Tắt)
        if (isBuzzerManual) {
             // Đang bật thủ công trên Web
             tone(BUZZER_PIN, 1000);
        } 
        else if (t > tempThreshold) {
           // Quá nhiệt -> Hú còi
           tone(BUZZER_PIN, 1000);
           client.publish(topic_st_buzzer, "Cảnh Báo Nhiệt!");
        } 
        else {
           // Bình thường -> Tắt còi
           noTone(BUZZER_PIN);
           digitalWrite(BUZZER_PIN, LOW); // Đảm bảo tắt hẳn điện
           client.publish(topic_st_buzzer, "Yên Lặng");
        }
      } 
      else {
        // TRƯỜNG HỢP CẢM BIẾN LỖI (Rút dây hoặc hỏng) -> Tắt còi cho đỡ ồn
        Serial.println("Lỗi đọc cảm biến DHT!");
        if (!isBuzzerManual) {
           noTone(BUZZER_PIN);
           digitalWrite(BUZZER_PIN, LOW);
        }
      }
    }
  }
}