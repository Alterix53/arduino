#include <WiFi.h>
#include <PubSubClient.h>
#include <ESP32Servo.h>
#include "DHT.h"
#include <LiquidCrystal_I2C.h>

// --- 1. CẤU HÌNH WIFI & MQTT ---
const char* ssid = "Wokwi-GUEST";
const char* password = "";
const char* mqtt_server = "broker.hivemq.com";

// --- 2. CÁC TOPIC MQTT ---
// Topic gửi lên (Publish)
const char* topic_temp      = "smartdoor/nhom10/temperature";
const char* topic_hum       = "smartdoor/nhom10/humidity";
const char* topic_st_door   = "smartdoor/nhom10/status/door";
const char* topic_st_buzzer = "smartdoor/nhom10/status/buzzer";
const char* topic_st_sensor = "smartdoor/nhom10/status/sensor";
const char* topic_alert     = "smartdoor/nhom10/alert"; // Topic gửi cảnh báo Pushsafer

// Topic nhận lệnh (Subscribe)
const char* topic_cmd = "smartdoor/nhom10/cmd"; // Lệnh điều khiển
const char* topic_lcd = "smartdoor/nhom10/lcd"; // Lệnh hiển thị chữ lên LCD

WiFiClient espClient;
PubSubClient client(espClient);

// --- 3. CẤU HÌNH PHẦN CỨNG ---
#define SERVO_PIN 13
#define TRIG_PIN  5 
#define ECHO_PIN  18 
#define DHT_PIN   15
#define BUZZER_PIN 4
#define LED_PIN    2    // Đèn cảnh báo
#define DHT_TYPE DHT22

Servo doorLock;
DHT dht(DHT_PIN, DHT_TYPE);
// LCD I2C (Địa chỉ thường là 0x27)
LiquidCrystal_I2C lcd(0x27, 16, 2);

// --- 4. BIẾN TOÀN CỤC ---
unsigned long lastMsg = 0;
unsigned long doorOpenTime = 0; 
unsigned long previousBlink = 0; 
unsigned long lastAlertTime = 0; // Biến chống spam tin nhắn Pushsafer

bool isDoorOpen = false;
bool ledState = LOW; 

// Biến Cấu hình (Mặc định)
bool isSensorActive = true;     
int tempThreshold = 40; // Ngưỡng nhiệt độ báo động
int distThreshold = 50; // Ngưỡng khoảng cách báo động (cm)
bool isBuzzerManual = false; 

// --- SETUP ---
void setup() {
  Serial.begin(115200);
  
  // Khởi tạo LCD
  lcd.init();
  lcd.backlight();
  lcd.setCursor(0, 0);
  lcd.print("SmartDoor Init...");

  // Khởi tạo Servo
  doorLock.attach(SERVO_PIN);
  doorLock.write(0); // Mặc định khóa
  
  // Khởi tạo Pin
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  dht.begin();
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT); 

  // Kết nối mạng
  setup_wifi();
  client.setServer(mqtt_server, 1883);
  client.setCallback(callback);
}

void setup_wifi() {
  delay(10);
  Serial.print("Connecting Wifi");
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }
  Serial.println(" Connected!");
}

// HÀM XỬ LÝ LỆNH NHẬN ĐƯỢC (ĐÃ CẬP NHẬT)
void callback(char* topic, byte* message, unsigned int length) {
  String msg = "";
  for (int i = 0; i < length; i++) msg += (char)message[i];
  
  Serial.print("Topic: "); Serial.print(topic);
  Serial.print(" | Msg: "); Serial.println(msg);

  // A. XỬ LÝ TIN NHẮN HIỂN THỊ LCD
  if (String(topic) == topic_lcd) {
      
      // KIỂM TRA: Nếu tin nhắn bắt đầu bằng "GREET:" (Là tin chào hỏi)
      if (msg.startsWith("GREET:")) {
          String name = msg.substring(6); // Cắt bỏ chữ "GREET:" lấy cái tên phía sau
          
          lcd.clear();
          // Dòng 1: Cố định
          lcd.setCursor(0, 0); 
          lcd.print("Welcome Home !");
          
          // Dòng 2: Hiển thị tên (Canh giữa cho đẹp nếu thích)
          lcd.setCursor(0, 1); 
          lcd.print(name); 
      } 
      // Nếu là tin nhắn bình thường (không có GREET)
      else {
          lcd.clear();
          lcd.setCursor(0, 0);
          lcd.print(msg); 
      }
      return; 
  }

  // B. XỬ LÝ LỆNH ĐIỀU KHIỂN (CMD) - (Giữ nguyên như cũ)
  if (String(topic) == topic_cmd) {
      if (msg == "OPEN") {
        doorLock.write(90); isDoorOpen = true; doorOpenTime = millis();
        client.publish(topic_st_door, "Đang Mở");
        // Khi mở cửa bằng nút, cũng có thể hiện câu chào mặc định
        lcd.clear(); lcd.setCursor(0,0); lcd.print("Welcome Home !");
      } 
      else if (msg == "CLOSE") {
        doorLock.write(0); isDoorOpen = false;
        client.publish(topic_st_door, "Đang Khóa");
        lcd.clear(); lcd.setCursor(0,0); lcd.print("Door Locked");
      }
      // ... (Các lệnh Buzzer/Sensor/Setting giữ nguyên không đổi) ...
      else if (msg == "BUZZER_ON") { isBuzzerManual = true; tone(BUZZER_PIN, 1000); }
      else if (msg == "BUZZER_OFF") { isBuzzerManual = false; noTone(BUZZER_PIN); }
      else if (msg == "SENSOR_ON") { isSensorActive = true; }
      else if (msg == "SENSOR_OFF") { isSensorActive = false; }
      else if (msg.startsWith("SET_TEMP:")) { tempThreshold = msg.substring(9).toInt(); }
      else if (msg.startsWith("SET_DIST:")) { distThreshold = msg.substring(9).toInt(); }
  }
}

void reconnect() {
  while (!client.connected()) {
    if (client.connect("ESP32_Nhom10_Unique_ID")) {
      // Đăng ký nhận tin từ 2 topic quan trọng
      client.subscribe(topic_cmd); 
      client.subscribe(topic_lcd); 
      
      client.publish(topic_st_door, "Đang Khóa");
      lcd.clear(); lcd.print("System Ready!");
    } else delay(5000);
  }
}

// --- VÒNG LẶP CHÍNH ---
void loop() {
  if (!client.connected()) reconnect();
  client.loop();

  // 1. TỰ ĐỘNG KHÓA CỬA (AUTO-LOCK)
  if (isDoorOpen && (millis() - doorOpenTime > 5000)) {
    doorLock.write(0); isDoorOpen = false;
    client.publish(topic_st_door, "Đang Khóa (Auto)");
    lcd.clear(); lcd.print("Auto Locked!");
  }

  // 2. LOGIC CẢM BIẾN KHOẢNG CÁCH (AN NINH)
  digitalWrite(TRIG_PIN, LOW); delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH); delayMicroseconds(10); digitalWrite(TRIG_PIN, LOW);
  long duration = pulseIn(ECHO_PIN, HIGH);
  int distance = duration * 0.034 / 2;

  // Nếu có người trong phạm vi cảnh báo
  if (distance > 0 && distance < distThreshold) {
      
      // a. Đèn LED chớp tắt (Cảnh báo tại chỗ)
      if (millis() - previousBlink >= 200) {
        previousBlink = millis();
        ledState = !ledState;
        digitalWrite(LED_PIN, ledState);
      }

      // b. Gửi cảnh báo PUSHSAFER (Cảnh báo từ xa)
      // Chỉ gửi 15 giây/lần để tránh spam điện thoại
      if (millis() - lastAlertTime > 15000) {
          lastAlertTime = millis();
          String alertMsg = "CANH BAO: Co nguoi la (" + String(distance) + "cm)";
          client.publish(topic_alert, alertMsg.c_str());
          Serial.println(">> SENT PUSHSAFER ALERT!");
      }

  } else {
      digitalWrite(LED_PIN, LOW); // Tắt đèn nếu an toàn
  }

  // 3. GỬI DỮ LIỆU ĐỊNH KỲ (2 GIÂY/LẦN)
  long now = millis();
  if (now - lastMsg > 2000) {
    lastMsg = now;
    if (isSensorActive) {
      float h = dht.readHumidity();
      float t = dht.readTemperature();
      if (!isnan(t) && !isnan(h)) {
        // Gửi nhiệt độ/độ ẩm
        client.publish(topic_temp, String(t, 1).c_str());
        client.publish(topic_hum, String(h, 1).c_str());
        
        // Logic Buzzer (Báo cháy nổ)
        if (isBuzzerManual) {
            tone(BUZZER_PIN, 1000);
        } else if (t > tempThreshold) {
           tone(BUZZER_PIN, 1000);
           client.publish(topic_st_buzzer, "Cảnh Báo Nhiệt!");
           // Có thể hiển thị cảnh báo lên LCD nếu muốn
           // lcd.setCursor(0,1); lcd.print("WARNING: HOT!"); 
        } else {
           noTone(BUZZER_PIN);
           client.publish(topic_st_buzzer, "Yên Lặng");
        }
      }
    }
  }
}