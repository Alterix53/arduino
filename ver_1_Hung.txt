#include <WiFi.h>
#include <PubSubClient.h>
#include <ESP32Servo.h>
#include "DHT.h"
#include <LiquidCrystal_I2C.h> // <--- Thư viện LCD

// --- WIFI & MQTT ---
const char* ssid = "Wokwi-GUEST";
const char* password = "";
const char* mqtt_server = "broker.hivemq.com";

// --- TOPIC ---
const char* topic_temp = "smartdoor/nhom10/temperature";
const char* topic_hum  = "smartdoor/nhom10/humidity";
const char* topic_st_door   = "smartdoor/nhom10/status/door";
const char* topic_st_buzzer = "smartdoor/nhom10/status/buzzer";
const char* topic_st_sensor = "smartdoor/nhom10/status/sensor";
const char* topic_cmd = "smartdoor/nhom10/cmd";

// TOPIC MỚI CHO LCD
const char* topic_lcd = "smartdoor/nhom10/lcd"; 

WiFiClient espClient;
PubSubClient client(espClient);

// --- PHẦN CỨNG ---
#define SERVO_PIN 13
#define TRIG_PIN  5 
#define ECHO_PIN  18 
#define DHT_PIN   15
#define BUZZER_PIN 4
#define LED_PIN    2    
#define DHT_TYPE DHT22

Servo doorLock;
DHT dht(DHT_PIN, DHT_TYPE);
// Khởi tạo LCD địa chỉ 0x27, 16 cột 2 dòng
LiquidCrystal_I2C lcd(0x27, 16, 2);

// --- BIẾN TOÀN CỤC ---
unsigned long lastMsg = 0;
unsigned long doorOpenTime = 0; 
unsigned long previousBlink = 0; 
bool isDoorOpen = false;
bool ledState = LOW; 

// Cấu hình
bool isSensorActive = true;     
int tempThreshold = 40;
int distThreshold = 50; 
bool isBuzzerManual = false; 

void setup() {
  Serial.begin(115200);
  
  // Khởi tạo LCD
  lcd.init();
  lcd.backlight();
  lcd.setCursor(0, 0);
  lcd.print("System Init...");

  doorLock.attach(SERVO_PIN);
  doorLock.write(0);
  
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  dht.begin();
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT); 

  setup_wifi();
  client.setServer(mqtt_server, 1883);
  client.setCallback(callback);
}

void setup_wifi() {
  delay(10);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }
}

// HÀM XỬ LÝ LỆNH NHẬN ĐƯỢC
void callback(char* topic, byte* message, unsigned int length) {
  String msg = "";
  for (int i = 0; i < length; i++) msg += (char)message[i];
  Serial.print("Topic: "); Serial.print(topic);
  Serial.print(" | Msg: "); Serial.println(msg);

  // 1. XỬ LÝ TIN NHẮN LCD (TỪ WEB GỬI XUỐNG)
  if (String(topic) == topic_lcd) {
      lcd.clear();
      lcd.setCursor(0, 0);
      lcd.print(msg); // In nội dung Web gửi
      // Nếu tin nhắn dài, bạn có thể xử lý in xuống dòng 2 ở đây
      return; // Xử lý xong thì thoát, không check lệnh khác
  }

  // 2. XỬ LÝ LỆNH ĐIỀU KHIỂN (CMD)
  if (String(topic) == topic_cmd) {
      if (msg == "OPEN") {
        doorLock.write(90); isDoorOpen = true; doorOpenTime = millis();
        client.publish(topic_st_door, "Đang Mở");
      } 
      else if (msg == "CLOSE") {
        doorLock.write(0); isDoorOpen = false;
        client.publish(topic_st_door, "Đang Khóa");
      }
      else if (msg == "BUZZER_ON") {
        isBuzzerManual = true; tone(BUZZER_PIN, 1000);
        client.publish(topic_st_buzzer, "Đang Kêu");
      }
      else if (msg == "BUZZER_OFF") {
        isBuzzerManual = false; noTone(BUZZER_PIN);
        client.publish(topic_st_buzzer, "Yên Lặng");
      }
      else if (msg == "SENSOR_ON") {
        isSensorActive = true; client.publish(topic_st_sensor, "Đang Bật");
      }
      else if (msg == "SENSOR_OFF") {
        isSensorActive = false; client.publish(topic_st_sensor, "Đã Tắt");
      }
      else if (msg.startsWith("SET_TEMP:")) {
        tempThreshold = msg.substring(9).toInt();
      }
      else if (msg.startsWith("SET_DIST:")) {
        distThreshold = msg.substring(9).toInt();
      }
  }
}

void reconnect() {
  while (!client.connected()) {
    if (client.connect("ESP32_Nhom10_Main")) {
      // Đăng ký nhận tin từ cả 2 topic
      client.subscribe(topic_cmd); // Topic lệnh
      client.subscribe(topic_lcd); // Topic hiển thị LCD
      
      client.publish(topic_st_door, "Đang Khóa");
      lcd.clear(); lcd.print("Ready to Connect");
    } else delay(5000);
  }
}

void loop() {
  if (!client.connected()) reconnect();
  client.loop();

  // Auto-Lock
  if (isDoorOpen && (millis() - doorOpenTime > 5000)) {
    doorLock.write(0); isDoorOpen = false;
    client.publish(topic_st_door, "Đang Khóa (Auto)");
    // Tự động báo lên LCD khi auto lock
    lcd.clear(); lcd.print("Auto Locked!");
  }

  // Logic đèn cảnh báo
  digitalWrite(TRIG_PIN, LOW); delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH); delayMicroseconds(10); digitalWrite(TRIG_PIN, LOW);
  long duration = pulseIn(ECHO_PIN, HIGH);
  int distance = duration * 0.034 / 2;

  if (distance > 0 && distance < distThreshold) {
      if (millis() - previousBlink >= 200) {
        previousBlink = millis();
        ledState = !ledState;
        digitalWrite(LED_PIN, ledState);
      }
  } else {
      digitalWrite(LED_PIN, LOW);
  }

  long now = millis();
  if (now - lastMsg > 2000) {
    lastMsg = now;
    if (isSensorActive) {
      float h = dht.readHumidity();
      float t = dht.readTemperature();
      if (!isnan(t) && !isnan(h)) {
        client.publish(topic_temp, String(t, 1).c_str());
        client.publish(topic_hum, String(h, 1).c_str());
        
        // Buzzer Logic
        if (isBuzzerManual) tone(BUZZER_PIN, 1000);
        else if (t > tempThreshold) {
           tone(BUZZER_PIN, 1000);
           client.publish(topic_st_buzzer, "Cảnh Báo Nhiệt!");
        } else {
           noTone(BUZZER_PIN);
           client.publish(topic_st_buzzer, "Yên Lặng");
        }
      }
    }
  }
}